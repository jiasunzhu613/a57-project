---
title: Investigation of NO~x~ (in ppb), O~3~ (in ppb), and PM~2.5~ (in µg/m3) trends in Ontario from 2003
  to 2022
author: "Mohamad Damaj - 10109, Moham An, Jo Zhu"
date: "2025-03-18"
output:
  pdf_document: default
  html_document:
    theme: lumen
header-includes:
  - \usepackage{caption}
  - \captionsetup{font={small}}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, include = FALSE}
library(tidyverse)
library(readxl)
library(patchwork)
library(lubridate)
library(kableExtra)
library(ggplot2)
library(lubridate)
library(knitr)
library(stringr)
library(tidygeocoder)
library(gridExtra)

```

```{r, include = FALSE}
NOX <- read_excel("./data/NOX.xlsx", skip = 3)
O3 <- read_excel("./data/O3.xlsx", skip = 3)
PM25 <- read_excel("./data/PM25.xlsx", skip = 5)
```


# 1. Description of Datasets

The datasets analyzed in this report are three, one for each of NO~x~ (in ppb), PM~2.5~ (in µg/m3), and O~3~ (in ppb), all containing the same variables. These datasets contain records of the pollutant levels from  2003 (considered the earliest of all three) to 2022. Each dataset contains detailed information of pollutant levels in the form of the following variables:

```{r, echo=F}

names(NOX)
```
1. Year:  The calendar year when the pollutant data was recorded.
2. Station Number: A unique numerical identifier for the monitoring station.
3. City: The name of the city where the pollutant was measured.
4. Location: A more specific description of the monitoring location (street, area).
5. Type: The type of monitoring station or measurement protocol used.
6. Valid Hour: The number of valid hourly measurements recorded for that pollutant in the given year.
7. Percentiles: Percentile statistics showing the distribution of pollutant levels (in ppb, µg/m3, ppb) throughout the year.
8. Mean: The annual average concentration of the pollutant (in ppb, µg/m3, ppb).
9. 1-Hour Maximum: The highest recorded concentration within a one-hour period during the year.
10. 24-Hour Maximum: The highest average concentration recorded over a 24-hour period in that year.


# 2. Background of the Data

The data used in this analysis was collected across various cities in Ontario, throughout the period from 2003 to 2022. These measurements were compiled and made available by the Ontario Ministry of the Environment, Conservation and Parks. 

The information is publically avaliable and is helpful in assiting researchers, policymakers, and public health officials to investigate air quality trends, evaluate the impact of environmental regulations, and inform policy decisions. It provides a long-term view of pollutant levels in various cities in Ontario, allowing for improving environmental and public health outcomes in Ontario.


# 3. Overall Research Question

The aim of this paper is to investigate the spatial and temporal trends of air pollutants (NO~x~, O~3~, and PM~2.5~) across various Ontario cities from 2003 to 2022. 

1. How have annual mean concentrations (in ppb, µg/m3, ppb) for each pollutant changed from 2003 to 2022, and which years show the most significant shifts?

2. Which cities consistently rank among the highest (or lowest) in terms of average pollutant levels, and do these rankings shift over time?

3. How do the four pollutants correlate with each other across different cities and years, and what might this indicate about broader air quality patterns?

4. How do the four pollutants project into future years based on current trends?





```{r, include=FALSE}

city_to_region <- data.frame(
  City = c(
    # Southwest
    "Windsor West",
    "Windsor Downtown",
    "Windsor North",
    "Grand Bend",
    "London",
    "Chatham",
    "Sarnia",
    "Brantford",
    "Kitchener",
    "St. Catharines",
    "St. Catherines",
    "Port Stanley",
    "Essex",
    "Hamilton Mountain",
    "Hamilton Downtown",
    "Hamilton West",
    "Guelph",

    
    
    # GTA (Greater Toronto Area) - including Halton/Peel/York/Durham
    "Toronto Downtown",
    "Toronto East",
    "Toronto North",
    "Toronto West",
    "Burlington",
    "Oakville",
    "Oshawa",
    "Brampton",
    "Mississauga",
    "Newmarket",
    "Milton",
    "Etobicoke West",
    "Stouffville",
    "Barrie",
    "Parry Sound",
    "Peterborough",
    
    # Eastern Ontario
    "Ottawa Downtown",
    "Ottawa Central",
    "Kingston",
    "Tiverton",
    "Belleville",
    "Cornwall",
    "Dorset",
    "Petawawa",
    "Morrisburg",
    
    # Northern Ontario
    "Sudbury",
    "Sault Ste. Marie",
    "North Bay",
    "Thunder Bay"
  ),
  Region = c(
    # Southwest
    "Western Ontario",
    "Western Ontario",
    "Western Ontario",
    "Western Ontario",
    "Western Ontario",
    "Western Ontario",
    "Western Ontario",
    "Western Ontario",
    "Western Ontario",
    "Western Ontario",
    "Western Ontario",
    "Western Ontario",
    "Western Ontario",
    "Western Ontario",
    "Western Ontario",
    "Western Ontario",
    "Western Ontario",



    
    # GTA
    "Central Ontario",
    "Central Ontario",
    "Central Ontario",
    "Central Ontario",
    "Central Ontario",
    "Central Ontario",
    "Central Ontario",
    "Central Ontario",
    "Central Ontario",
    "Central Ontario",
    "Central Ontario",
    "Central Ontario",
    "Central Ontario",

    
    
    # Central Ontario
    "Central Ontario",
    "Central Ontario",

    # Eastern Ontario
    "Eastern Ontario",
    "Eastern Ontario",
    "Eastern Ontario",
    "Eastern Ontario",
    "Eastern Ontario",
    "Eastern Ontario",
    "Eastern Ontario",
    "Eastern Ontario",
    "Eastern Ontario",
    "Eastern Ontario",

    
    # Northern Ontario
    "Northern Ontario",
    "Northern Ontario",
    "Northern Ontario",
    "Northern Ontario"
  ),
  stringsAsFactors = FALSE
)


NOX = NOX %>% mutate(Mean = as.numeric(Mean)) %>%  
  filter(Year >= 2003)
O3 = O3 %>% mutate(Mean = as.numeric(Mean)) %>%  
  filter(Year >= 2003)
PM25 = PM25 %>% mutate(Mean = as.numeric(Mean)) %>% 
  mutate(Year = as.integer(Year)) %>%  filter(Year >= 2003)
```

```{r, echo = F}
O3 = O3 %>% drop_na(Mean)
NOX = NOX %>% drop_na(Mean)
PM25 = PM25 %>% drop_na(Mean)
```

```{r, echo = F}
NOX = NOX %>% left_join(city_to_region, by = "City")
O3 = O3 %>% left_join(city_to_region, by = "City")
PM25 = PM25 %>% left_join(city_to_region, by = "City")


```


```{r, echo = F}
# Make tables
# Mean per years for that particulate matter

NOX_City_mean <- NOX %>% group_by(City) %>% summarise(Conc. = mean(Mean))


O3_City_mean <- O3 %>% group_by(City) %>% summarise(Conc. = mean(Mean))
PM25_City_mean <- PM25 %>% group_by(City) %>% summarise(Conc. = mean(Mean))


```


# 4. Tables


## 4.1 The Top 10 Cities With the Highest Pollutant Concentration 


```{r, echo = F, results='asis'}

NOX_table <- kable(NOX_City_mean %>% mutate(Conc. = round(Conc., 2)) %>% arrange(desc(Conc.)) %>% head(10), "latex")
O3_table <- kable(O3_City_mean %>% mutate(Conc. = round(Conc., 2)) %>% arrange(desc(Conc.)) %>% head(10), "latex")
PM25_table <- kable(PM25_City_mean %>% mutate(Conc. = round(Conc.,2)) %>% arrange(desc(Conc.)) %>% head(10), "latex")
cat("
\\begin{table}[ht]
\\begin{minipage}[t]{0.3\\linewidth}
\\captionsetup{labelformat=empty, labelsep=none}
\\caption{NO$_{x}$ Table (in ppb)}
", NOX_table, "
\\end{minipage}
\\hfill
\\begin{minipage}[t]{0.3\\linewidth}
\\captionsetup{labelformat=empty, labelsep=none}
\\caption{O$_{3}$ Table (in ppb)}
", O3_table, "
\\end{minipage}
\\hfill
\\begin{minipage}[t]{0.3\\linewidth}
\\captionsetup{labelformat=empty, labelsep=none}
\\caption{PM$_{2.5}$ Table (in  µg/m$_{3}$)}
", PM25_table, "
\\end{minipage}
\\setcounter{table}{0}
\\caption{Top 10 Cities with Highest Concentration of Each Pollutant}
\\end{table}
")



```

The table above is three separate tables each one for a respective pollutant, they are sorted in descending Mean and only the top 10 are being shown based on the overall Mean of the City, over all years from 2003 to 2022; as such, the cities with the high concentration will be listed first. Therefore, we can draw a few key observations about pollutant concentrations across these Ontario cities:

  - The highest mean NO~x~ readings (31.32 ppb) appear at Toronto West, followed closely by other Toronto stations (Toronto East, Toronto Downtown) and industrial/urban areas like Hamilton and Windsor.
  
  - Port Stanley shows the highest O~3~ levels (32.84 ppb), with other high concentrations at Tiverton, Grand Bend, and Parry Sound—generally smaller or semi-rural communities.
  
  - Sarnia tops the PM~2.5~ list (9.57 µg/m~3~), followed by Windsor (West and Downtown) and Hamilton stations, reflecting the influence of industrial facilities and cross-border pollution.




 

```{r, include = F}
NOX_Region = NOX %>% group_by(Year, Region) %>% summarise(Conc. = mean(Mean))
O3_Region = O3 %>% group_by(Year, Region) %>% summarise(Conc. = mean(Mean))
PM25_Region = PM25 %>% group_by(Year, Region) %>% summarise(Conc. = mean(Mean))


```
## 4.2 The Top 10 Regions and Years with Highest Concentration of Each Pollutant

In order to view the pollutant concentration changes by region, we grouped the cities by region based on the map of Ontario from the Ministry of Natural Resources and Forestry, and calculated the mean of the cities in each region grouped by year.

```{r, results='asis', echo=FALSE}


# Create the LaTeX tables without caption
NOX_tab  <- kable(NOX_Region  %>% mutate(Conc. = round(Conc., 2)) %>% arrange(desc(Conc.)) %>% head(10), "latex")
O3_tab   <- kable(O3_Region   %>% mutate(Conc. = round(Conc., 2)) %>% arrange(desc(Conc.)) %>% head(10), "latex")
PM25_tab <- kable(PM25_Region %>% mutate(Conc. = round(Conc., 2)) %>% arrange(desc(Conc.)) %>% head(10), "latex")


cat("
\\begin{table}[ht]
\\begin{minipage}[t]{0.3\\linewidth}
\\captionsetup{labelformat=empty, labelsep=none}
\\caption{NO$_{x}$ Table (in ppb)}
", NOX_tab, "
\\end{minipage}
\\hfill
\\begin{minipage}[t]{0.3\\linewidth}
\\captionsetup{labelformat=empty, labelsep=none}
\\caption{O$_{3}$ Table (in ppb)}
", O3_tab, "
\\end{minipage}
\\hfill
\\begin{minipage}[t]{0.3\\linewidth}
\\captionsetup{labelformat=empty, labelsep=none}
\\caption{PM$_{2.5}$ Table (in  µg/m$_{3}$)}
", PM25_tab, "
\\end{minipage}
\\setcounter{table}{1}
\\caption{Top 10 Regions and Years with Highest Concentration of Each Pollutant}
\\end{table}
\\vspace{-17mm}
# ")

```



  This table follows a similar format to the Table 1, listing the highest concentrations first. The concentrations of NO~x~ (in ppb) and PM~2.5~ (in µg/m~3~) were highest in the early to mid-2000s, particularly in Western and Central Ontario, and have since declined. Meanwhile, O~3~ (in ppb) levels are highest in Western Ontario dominating the top 10 with Northern Ontario not occupying a single spot. The O~3~ concentrations show minor decrease, likely reflecting O~3~ long lifespan in the atmosphere. 


## 4.3 The Top 10 Years with Highest Concentration of Each Pollutant

```{r, echo = F, results ='asis'}
NOX_Yearly_Mean = NOX %>% group_by(Year) %>% summarise(Conc. = round(mean(Mean), 2))
O3_Yearly_Mean = O3 %>% group_by(Year) %>% summarise(Conc. = round(mean(Mean),2))
PM25_Yearly_Mean = PM25 %>% group_by(Year) %>% summarise(Conc. = round(mean(Mean) ,2))

NOX_tab  <- kable(NOX_Yearly_Mean  %>% mutate(Conc. = round(Conc., 2)) %>% arrange(desc(Conc.)) %>% head(10), "latex")
O3_tab   <- kable(O3_Yearly_Mean   %>% mutate(Conc. = round(Conc., 2)) %>% arrange(desc(Conc.)) %>% head(10), "latex")
PM25_tab <- kable(PM25_Yearly_Mean %>% mutate(Conc. = round(Conc., 2)) %>% arrange(desc(Conc.)) %>% head(10), "latex") 

cat("
\\begin{table}[ht]
\\centering
\\begin{minipage}[t]{0.3\\linewidth}
  \\centering
  \\captionsetup{labelformat=empty, labelsep=none}
  \\caption{NO$_{x}$ Table (in ppb)}
", NOX_tab, "
\\end{minipage}
\\quad
\\begin{minipage}[t]{0.3\\linewidth}
  \\centering
  \\captionsetup{labelformat=empty, labelsep=none}
  \\caption{O$_{3}$ Table (in ppb)}
", O3_tab, "
\\end{minipage}
\\quad
\\begin{minipage}[t]{0.3\\linewidth}
  \\centering
  \\captionsetup{labelformat=empty, labelsep=none}
  \\caption{PM$_{2.5}$ Table (in  µg/m$_{3}$)}
", PM25_tab, "
\\end{minipage}
\\setcounter{table}{2}
\\caption{Top 10 Years with the Highest Concentration}
\\end{table}
")

```

The table reveals that NO~x~ levels peaked in 2003 -- the first year of the dataset -- and has steadily decreased since. Additionally, PM~2.5~ concentrations were highest in the mid-2000s before decreasing, and O~3~ levels, which peaked around 2010–2012, have remained relatively high before a minor decrease in later years.



# 5. Graphs

## 5.1 Line Charts of Yearly Concentration by Region  
```{r, echo = F}

plot_NOX  <- ggplot(NOX_Region, aes(x = Year, y = Conc., col = Region)) + 
  geom_line() + 
  facet_wrap(~ Region) + 
  labs(title = expression(NO[x] ~ "Concentration by Region"), x = "Year", y = "Concentration (in ppb)") +
  theme_minimal() +
  theme(legend.position = "none", strip.text = element_blank())

plot_O3 <- ggplot(O3_Region, aes(x = Year, y = Conc., col = Region)) + 
  geom_line() + 
  facet_wrap(~ Region) + 
  labs(title = expression(O[3] ~ "Concentration by Region"), x = "Year", y = "Concentration (in ppb)") +
  theme_minimal() +
  theme(legend.position = "none", strip.text = element_blank())

plot_PM25 <- ggplot(PM25_Region, aes(x = Year, y = Conc., col = Region)) + 
  geom_line() + 
  facet_wrap(~ Region) + 
  labs(title = expression(PM[2.5] ~ "Concentration by Region"), x = "Year", y = expression("Concentration (in" ~ µg/m[3] *")")) +
  theme_minimal() +
  theme(legend.position = "none", strip.text = element_blank())

(plot_NOX | plot_O3) / plot_PM25 +
  plot_layout(guides = "collect") & theme(legend.position = "bottom")
```

The Line Charts of Yearly Concentration by Region display the concentration of each pollutant faceted by region over 2003 till 2022. The x-axes represent the year and the y-axes represent the concentration of the pollutant at that year in its respective unit.    

The graphs reveal a notable improvement in air quality over the years, with clear declines in both NO~x~ and PM~2.5~ levels across all regions, suggesting that emission controls and cleaner technologies have had a significant impact. NO~x~ concentrations show a consistent downward trend from higher levels in the early years, converging towards lower values by 2020, while PM~2.5~ levels exhibit a marked decrease, with the initial difference between regions decreasing over time. In contrast, O~3~ concentrations appear relatively stable -- with some fluctuations -- which reflects the complex nature of ozone formation that depends on multiple factors such as sunlight, temperature, and precursor emissions. 


## 5.2 Scatter Plot of Overall Pollutant Concentration by Year  
```{r, echo = F, fig.width=10, fig.height=5}

Yearly_Means = list(NOX_Yearly_Mean, PM25_Yearly_Mean, O3_Yearly_Mean)

Combined_Yearly_Mean = reduce(Yearly_Means, full_join, by = "Year")


Graphing_Yearly_Means <- Combined_Yearly_Mean %>% 
               pivot_longer(cols = starts_with("Conc."),
               names_to = "Pollutant",
               values_to = "Value")
ggplot(Graphing_Yearly_Means, 
       aes(x = Year, y = Value, 
           col = factor(Pollutant, 
                        levels = c("Conc..x", "Conc.", "Conc..y")))) + 
      geom_point() +
      labs(col = "Pollutant", y = "Concentration", title = "Total Concentration by Year ") + 
  scale_color_discrete(labels = c(expression(NO[x] ~ "(in ppb)"), expression(O[3] ~ "(in ppb"), expression(PM[2.5] ~ "(in" ~ µg/m[3] *
  ")"))) + theme(legend.position = "bottom")

```

This Scatterplot of Overall Pollutant Concentration by Region displays the overall concentration, calculated by taking the mean of each year for all cities in the dataset, of each pollutant  over 2003 till 2022. The x-axes represent the year and the y-axes represent the concentration of the pollutant at that year in its respective unit.

The plot reveals a downward trends of NO~x~ until 2020, with concentrations appearing to drop from around 25 ppb to near 8 ppb in 2020.  This substantial decrease suggests that measures aimed at reducing emissions through regulations and increased standards have been effectively implemented over the years. On the other hand, PM~2.5~ and O~3~ do not show a steady downward trend; instead, their concentrations fluctuate over the period analyzed. These fluctuations show the challenges in the efforts of controlling pollutants that are not directly emitted but are produced by chemical interactions in the atmosphere. 

## 5.3 Heatmap



# 6. Hypothesis Testing
## 6.1 Paired T-test
compare the value of two years (2003, 2022), x_2003, x_2022
H_0: u_1 - u_2 = 0
H_a: u_1 - u_2 != 0

```{r, echo = F}
# find 2003, 2022
values.2003 = NOX %>% filter(Year == 2003) %>% select(City, Mean)
values.2022 = NOX %>% filter(Year == 2022) %>% select(City, Mean)
values = left_join(values.2003, values.2022, by="City")
values = values %>% mutate(diff = Mean.x - Mean.y)
t.test(values$diff)
```
```{r, echo = F}
# find 2003, 2022
values.2003 = O3 %>% filter(Year == 2003) %>% select(City, Mean)
values.2022 = O3 %>% filter(Year == 2022) %>% select(City, Mean)
values = left_join(values.2003, values.2022, by="City")
values = values %>% mutate(diff = Mean.x - Mean.y)
t.test(values$diff)
```
```{r, echo = F}
# find 2003, 2022
values.2003 = PM25 %>% filter(Year == 2003) %>% select(City, Mean)
values.2022 = PM25 %>% filter(Year == 2022) %>% select(City, Mean)
values = left_join(values.2003, values.2022, by="City")
values = values %>% mutate(diff = Mean.x - Mean.y)
t.test(values$diff)
```



